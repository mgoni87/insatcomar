<?php// Enable error reporting for debuggingini_set('display_errors', 1);ini_set('display_startup_errors', 1);error_reporting(E_ALL);// Configuration// Database configurationdefine('DB_HOST', 'localhost');define('DB_USER', 'insatcomar_usr');define('DB_PASS', 'H~B(%rIjcGw-');define('DB_NAME', 'insatcomar_dbctes');// Scraper Configurationdefine('SCRAPER_LOGIN_URL', 'https://portal.orbith.com/admin/admin/index.php');define('LOGIN_USR', 'hola@insat.com.ar');define('LOGIN_PASS', 'w[GY9q511Cf4');define('ACTIVACION_VIEW_URL', 'https://portal.orbith.com/admin/admin/index.php?operation=activacionView');define('ACTIVACION_DETAIL_URL', 'https://portal.orbith.com/admin/admin/index.php?operation=activacionDetail&id=');define('ESTADO_RED_VIEW_URL', 'https://portal.orbith.com/admin/admin/index.php?operation=estado_redView');define('SIGNAL_DATA_URL', 'https://portal.orbith.com/admin/admin/index.php?operation=estado_redView&stats=1');define('COOKIE_FILE', 'orbith_cookies.txt');define('LOG_FILE', 'login_log.txt');// Logging functionfunction logMessage($message) {    $timestamp = date('Y-m-d H:i:s');    file_put_contents(LOG_FILE, "[$timestamp] $message\n", FILE_APPEND);}// Initialize cURL sessionfunction initCurl() {    $ch = curl_init();    curl_setopt($ch, CURLOPT_COOKIEFILE, COOKIE_FILE);    curl_setopt($ch, CURLOPT_COOKIEJAR, COOKIE_FILE);    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);    curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36');    curl_setopt($ch, CURLOPT_TIMEOUT, 30);    curl_setopt($ch, CURLOPT_HEADER, true);        return $ch;}// Save cookies to Netscape formatfunction saveCookiesToFile($cookieFile) {    $cookies = file_get_contents($cookieFile);    $lines = explode("\n", $cookies);    $netscapeCookies = "# Netscape HTTP Cookie File\n";    foreach ($lines as $line) {        if (empty($line) || strpos($line, '#') === 0) {            continue;        }        $parts = explode("\t", $line);        if (count($parts) >= 7) {            $netscapeCookies .= implode("\t", $parts) . "\n";        }    }    file_put_contents(COOKIE_FILE, $netscapeCookies);    logMessage("Cookies saved to " . COOKIE_FILE);}// Create activations tablefunction createTable($pdo) {    try {        $sql = "CREATE TABLE IF NOT EXISTS activations (            act INT PRIMARY KEY,            nro_doc BIGINT,            esno_activacion DECIMAL(10,2),            latitud DECIMAL(10,8),            longitud DECIMAL(10,8),            id INT,            modem_id INT,            hub VARCHAR(20),            activo TINYINT(1) DEFAULT 1        )";                $pdo->exec($sql);        logMessage("Activations table created successfully");    } catch (PDOException $e) {        logMessage("Error creating activations table: " . $e->getMessage());        die("Error creating activations table: " . $e->getMessage());    }}// Create signal_data tablefunction createSignalTable($pdo) {    try {        $sql = "CREATE TABLE IF NOT EXISTS signal_data (            act INT,            timestamp DATETIME,            EsNO DECIMAL(10,2),            CNO DECIMAL(10,2),            PRIMARY KEY (act, timestamp),            FOREIGN KEY (act) REFERENCES activations(act)        )";                $pdo->exec($sql);        logMessage("Signal_data table created successfully");    } catch (PDOException $e) {        logMessage("Error creating signal_data table: " . $e->getMessage());        die("Error creating signal_data table: " . $e->getMessage());    }}// Delete signal data older than 15 daysfunction deleteOldSignalData($pdo) {    try {        $sql = "DELETE FROM signal_data WHERE timestamp < DATE_SUB(NOW(), INTERVAL 15 DAY)";        $affectedRows = $pdo->exec($sql);        logMessage("Deleted $affectedRows signal data records older than 15 days");    } catch (PDOException $e) {        logMessage("Error deleting old signal data: " . $e->getMessage());        die("Error deleting old signal data: " . $e->getMessage());    }}// Get total pages from viewfunction getTotalPages($ch, $url) {    curl_setopt($ch, CURLOPT_URL, $url);    curl_setopt($ch, CURLOPT_POST, false);    curl_setopt($ch, CURLOPT_HTTPHEADER, [        'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'    ]);    $response = curl_exec($ch);        if ($response === false) {        logMessage("Failed to fetch URL $url: " . curl_error($ch));        return 1;    }        $headerSize = curl_getinfo($ch, CURLINFO_HEADER_SIZE);    $body = substr($response, $headerSize);        // Check for authentication errors    if (strpos($body, '<form') !== false && strpos($body, 'username') !== false) {        logMessage("Authentication failed: Redirected to login page when fetching $url");        die("Authentication failed: Redirected to login page");    }        logMessage("Fetched URL: $url");        if (preg_match('/Total: (\d+)/', $body, $matches)) {        $totalRecords = (int)$matches[1];        $pages = ceil($totalRecords / 30);        logMessage("Total records: $totalRecords, Total pages: $pages");        return $pages;    }        logMessage("Could not parse total records, defaulting to 1 page");    return 1;}// Scrape activacionViewfunction scrapeActivacionView($ch, $pdo, &$records) {    $totalPages = getTotalPages($ch, ACTIVACION_VIEW_URL);    logMessage("Starting scrape of activacionView, total pages: $totalPages");        for ($page = 1; $page <= $totalPages; $page++) {        curl_setopt($ch, CURLOPT_URL, ACTIVACION_VIEW_URL . "&page=$page");        $response = curl_exec($ch);                if ($response === false) {            logMessage("Failed to fetch page $page: " . curl_error($ch));            continue;        }                $headerSize = curl_getinfo($ch, CURLINFO_HEADER_SIZE);        $body = substr($response, $headerSize);                // Save raw HTML for debugging        file_put_contents("activacion_view_page_$page.html", $body);        logMessage("Saved raw HTML for page $page to activacion_view_page_$page.html");                logMessage("Processing page $page");                // Ensure UTF-8 encoding        $body = mb_convert_encoding($body, 'HTML-ENTITIES', 'UTF-8');                $doc = new DOMDocument();        @$doc->loadHTML($body); // Suppress warnings for malformed HTML        $xpath = new DOMXPath($doc);                // Try a more flexible XPath query        $rows = $xpath->query('//table[contains(@class, "table")]/tbody/tr');        if ($rows->length === 0) {            // Fallback query in case table class is different            $rows = $xpath->query('//table//tr[td]');            logMessage("No rows found with primary query, using fallback query");        }                logMessage("Found " . $rows->length . " rows on page $page");                foreach ($rows as $row) {            $cells = $xpath->query('td', $row);            if ($cells->length >= 10) { // Ensure enough cells are present                $act = trim($cells->item(0)->textContent); // Service ID                if ($act === '') {                    logMessage("Empty Service ID found on page $page, skipping row");                    continue;                }                                $records[] = [                    'act' => $act,                    'nro_doc' => trim($cells->item(7)->textContent), // Nro Doc.                    'esno_activacion' => floatval(trim($cells->item(9)->textContent)), // Esn0                    'latitud' => null,                    'longitud' => null,                    'id' => null,                    'modem_id' => null,                    'hub' => null,                    'activo' => 1                ];                logMessage("Added record with act: $act");            } else {                logMessage("Incomplete row found on page $page, cells: " . $cells->length);            }        }    }        logMessage("Total records collected from activacionView: " . count($records));}// Scrape activacionDetail for lat/longfunction scrapeActivacionDetail($ch, &$records) {    foreach ($records as &$record) {        $url = ACTIVACION_DETAIL_URL . $record['act'];        curl_setopt($ch, CURLOPT_URL, $url);        $response = curl_exec($ch);                if ($response === false) {            logMessage("Failed to fetch detail for act {$record['act']}: " . curl_error($ch));            continue;        }                $headerSize = curl_getinfo($ch, CURLINFO_HEADER_SIZE);        $body = substr($response, $headerSize);                logMessage("Processing detail for act: {$record['act']}");                $doc = new DOMDocument();        @$doc->loadHTML($body);        $xpath = new DOMXPath($doc);                $lat = $xpath->query('//tr/td[contains(.,"Latitud")]/following-sibling::td[1]');        $lon = $xpath->query('//tr/td[contains(.,"Longitud")]/following-sibling::td[1]');                if ($lat->length > 0) {            $record['latitud'] = floatval(trim($lat->item(0)->textContent));            logMessage("Latitud for act {$record['act']}: {$record['latitud']}");        } else {            logMessage("No latitud found for act {$record['act']}");        }                if ($lon->length > 0) {            $record['longitud'] = floatval(trim($lon->item(0)->textContent));            logMessage("Longitud for act {$record['act']}: {$record['longitud']}");        } else {            logMessage("No longitud found for act {$record['act']}");        }    }}// Scrape estado_redView for modem_id and hubfunction scrapeEstadoRedView($ch, &$records) {    $totalPages = getTotalPages($ch, ESTADO_RED_VIEW_URL);    logMessage("Starting scrape of estado_redView, total pages: $totalPages");        for ($page = 1; $page <= $totalPages; $page++) {        curl_setopt($ch, CURLOPT_URL, ESTADO_RED_VIEW_URL . "&page=$page");        $response = curl_exec($ch);                if ($response === false) {            logMessage("Failed to fetch estado_redView page $page: " . curl_error($ch));            continue;        }                $headerSize = curl_getinfo($ch, CURLINFO_HEADER_SIZE);        $body = substr($response, $headerSize);                logMessage("Processing estado_redView page $page");                $doc = new DOMDocument();        @$doc->loadHTML($body);        $xpath = new DOMXPath($doc);                $rows = $xpath->query('//tr[@data-listview-item]');        logMessage("Found " . $rows->length . " rows on estado_redView page $page");                foreach ($rows as $row) {            $cells = $xpath->query('td', $row);            $actions = $xpath->query('.//a[contains(@onclick, "get_stats")]', $row);            $ping = $xpath->query('.//a[contains(@onclick, "ping_terminal")]', $row);                        if ($actions->length > 0 && $ping->length > 0) {                preg_match('/get_stats\((\d+),\s*\'([^\']+)\'\)/', $actions->item(0)->getAttribute('onclick'), $statsMatch);                preg_match('/ping_terminal\((\d+)\)/', $ping->item(0)->getAttribute('onclick'), $pingMatch);                                if ($statsMatch && $pingMatch) {                    $act = $pingMatch[1];                    $modem_id = $statsMatch[1];                    $hub = $statsMatch[2];                                        foreach ($records as &$record) {                        if ($record['act'] == $act) {                            $record['modem_id'] = $modem_id;                            $record['hub'] = $hub;                            logMessage("Matched act $act: modem_id=$modem_id, hub=$hub");                            break;                        }                    }                } else {                    logMessage("Failed to parse get_stats or ping_terminal for row on page $page");                }            } else {                logMessage("No actions or ping_terminal found for row on page $page");            }        }    }}// Scrape signal data (EsNO and CNO)function scrapeSignalData($ch, $pdo, &$records) {    $stmt = $pdo->prepare("SELECT timestamp FROM signal_data WHERE act = :act");        foreach ($records as &$record) {        if (empty($record['modem_id']) || empty($record['hub'])) {            logMessage("Skipping signal data for act {$record['act']}: missing modem_id or hub");            continue;        }                $url = SIGNAL_DATA_URL . "&modem_id={$record['modem_id']}&hub={$record['hub']}";        curl_setopt($ch, CURLOPT_URL, $url);        $response = curl_exec($ch);                if ($response === false) {            logMessage("Failed to fetch signal data for act {$record['act']}: " . curl_error($ch));            continue;        }                $headerSize = curl_getinfo($ch, CURLINFO_HEADER_SIZE);        $body = substr($response, $headerSize);                logMessage("Processing signal data for act: {$record['act']}");                // Extract Highcharts script        preg_match("/Highcharts\.chart\('container', \{.*?\}\);/s", $body, $chartMatch);        logMessage("Highcharts match found: " . (empty($chartMatch) ? "No" : "Yes"));        if (!$chartMatch) {            logMessage("No Highcharts data found for act {$record['act']}");            continue;        }                // Parse series data with multiline support        preg_match_all("/data:\s*\[\s*([^\[\]]*(?:\s*\[\s*\d+\s*,\s*[\d.]+\s*\](?:\s*,)?\s*)*)\]/s", $chartMatch[0], $seriesMatches);        logMessage("Series matches found: " . count($seriesMatches[1]));        if (count($seriesMatches[1]) < 2) {            logMessage("Incomplete series data for act {$record['act']}: " . json_encode($seriesMatches[1]));            continue;        }                // Extract CNO and EsNO data        $cnoData = trim($seriesMatches[1][0]);        $esnoData = trim($seriesMatches[1][1]);        logMessage("CNO data raw: $cnoData");        logMessage("EsNO data raw: $esnoData");                // Parse points manually to handle multiline or malformed data        $cnoPoints = [];        if (preg_match_all("/\[(\d+),\s*([\d.]+)\]/", $cnoData, $matches)) {            for ($i = 0; $i < count($matches[0]); $i++) {                $cnoPoints[] = [$matches[1][$i], $matches[2][$i]];            }        }        $esnoPoints = [];        if (preg_match_all("/\[(\d+),\s*([\d.]+)\]/", $esnoData, $matches)) {            for ($i = 0; $i < count($matches[0]); $i++) {                $esnoPoints[] = [$matches[1][$i], $matches[2][$i]];            }        }                logMessage("CNO points count: " . count($cnoPoints));        logMessage("EsNO points count: " . count($esnoPoints));                if (count($cnoPoints) !== count($esnoPoints)) {            logMessage("Mismatched data points for act {$record['act']}: CNO=" . count($cnoPoints) . ", EsNO=" . count($esnoPoints));            continue;        }                // Check existing timestamps with exact format        $stmt->execute([':act' => $record['act']]);        $existingTimestamps = array_column($stmt->fetchAll(PDO::FETCH_ASSOC), 'timestamp');        logMessage("Existing timestamps for act {$record['act']}: " . json_encode($existingTimestamps));                $signalRecords = [];        for ($i = 0; $i < count($cnoPoints); $i++) {            $timestampMs = (int)$cnoPoints[$i][0];            // Ensure timestamp is in UTC and formatted exactly to seconds            $timestamp = gmdate('Y-m-d H:i:s', (int)($timestampMs / 1000));            $cno = floatval($cnoPoints[$i][1]);            $esno = floatval($esnoPoints[$i][1]);            logMessage("Processing point $i for act {$record['act']}: timestamp=$timestamp, CNO=$cno, EsNO=$esno");                        // Normalize timestamp for comparison            if (in_array($timestamp, $existingTimestamps, true)) {                logMessage("Skipping duplicate timestamp $timestamp for act {$record['act']}");                continue;            }                        $signalRecords[] = [                'act' => $record['act'],                'timestamp' => $timestamp,                'EsNO' => $esno,                'CNO' => $cno            ];        }                // Batch insert signal data with ON DUPLICATE KEY UPDATE        if (!empty($signalRecords)) {            $placeholders = rtrim(str_repeat('(?,?,?,?),', count($signalRecords)), ',');            $sql = "INSERT INTO signal_data (act, timestamp, EsNO, CNO) VALUES $placeholders                     ON DUPLICATE KEY UPDATE EsNO = VALUES(EsNO), CNO = VALUES(CNO)";            $insertStmt = $pdo->prepare($sql);                        $params = [];            foreach ($signalRecords as $signalRecord) {                $params[] = $signalRecord['act'];                $params[] = $signalRecord['timestamp'];                $params[] = $signalRecord['EsNO'];                $params[] = $signalRecord['CNO'];            }                        try {                $insertStmt->execute($params);                logMessage("Batch inserted/updated " . count($signalRecords) . " signal data records for act {$record['act']}");            } catch (PDOException $e) {                logMessage("Error batch inserting signal data for act {$record['act']}: " . $e->getMessage());            }        } else {            logMessage("No new signal data to save for act {$record['act']}");        }    }}// Save records to databasefunction saveToDatabase($pdo, $records) {    logMessage("Saving " . count($records) . " records to activations table");        // Reset all activo flags to 0    $pdo->exec("UPDATE activations SET activo = 0");    logMessage("Reset all activo flags to 0");        $stmt = $pdo->prepare("        INSERT INTO activations (act, nro_doc, esno_activacion, latitud, longitud, id, modem_id, hub, activo)        VALUES (:act, :nro_doc, :esno_activacion, :latitud, :longitud, :id, :modem_id, :hub, :activo)        ON DUPLICATE KEY UPDATE            nro_doc = VALUES(nro_doc),            esno_activacion = VALUES(esno_activacion),            latitud = VALUES(latitud),            longitud = VALUES(longitud),            id = VALUES(id),            modem_id = VALUES(modem_id),            hub = VALUES(hub),            activo = VALUES(activo)    ");        foreach ($records as $record) {        try {            $stmt->execute([                ':act' => $record['act'],                ':nro_doc' => $record['nro_doc'],                ':esno_activacion' => $record['esno_activacion'],                ':latitud' => $record['latitud'],                ':longitud' => $record['longitud'],                ':id' => $record['id'],                ':modem_id' => $record['modem_id'],                ':hub' => $record['hub'],                ':activo' => $record['activo']            ]);            logMessage("Saved/updated record for act: {$record['act']}");        } catch (PDOException $e) {            logMessage("Error saving record for act {$record['act']}: " . $e->getMessage());        }    }}// Main executiontry {    // Initialize database connection    $pdo = new PDO("mysql:host=" . DB_HOST . ";dbname=" . DB_NAME, DB_USER, DB_PASS);    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);        // Create tables    createTable($pdo);    createSignalTable($pdo);        // Delete old signal data    deleteOldSignalData($pdo);        // Initialize cURL    $ch = initCurl();        // Step 1: Perform login    $postFields = [        'username' => LOGIN_USR,        'password' => LOGIN_PASS    ];    logMessage("POST data: " . http_build_query($postFields));        curl_setopt($ch, CURLOPT_URL, SCRAPER_LOGIN_URL);    curl_setopt($ch, CURLOPT_POST, true);    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($postFields));    curl_setopt($ch, CURLOPT_HTTPHEADER, [        'Content-Type: application/x-www-form-urlencoded',        'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'    ]);        $response = curl_exec($ch);    if ($response === false) {        $error = "Login failed: " . curl_error($ch);        logMessage($error);        die($error);    }        $headerSize = curl_getinfo($ch, CURLINFO_HEADER_SIZE);    $headers = substr($response, 0, $headerSize);    $body = substr($response, $headerSize);    file_put_contents('login_response.html', $body);    file_put_contents('login_response_headers.txt', $headers);    logMessage("Login attempt completed, response saved to login_response.html and login_response_headers.txt");        // Check for login errors    if (strpos($body, 'ValueError: Path must not be empty') !== false) {        logMessage("Login failed: ValueError: Path must not be empty");        die("Login failed: ValueError: Path must not be empty. Check credentials or contact administrator.");    }        if (strpos($body, '<form') !== false && strpos($body, 'username') !== false) {        logMessage("Login failed: Redirected back to login page");        die("Login failed: Redirected back to login page. Check credentials or try fetching login page first.");    }        if (preg_match_all('/Set-Cookie: ([^;]+)/i', $headers, $matches)) {        logMessage("Cookies after login: " . implode(', ', $matches[1]));    } else {        logMessage("No cookies set after login");    }        // Save cookies    saveCookiesToFile(COOKIE_FILE);        logMessage("Login successful, cookies saved to " . COOKIE_FILE);        // Step 2: Fetch activations page using cookies    curl_setopt($ch, CURLOPT_URL, ACTIVACION_VIEW_URL);    curl_setopt($ch, CURLOPT_POST, false);    curl_setopt($ch, CURLOPT_HTTPHEADER, [        'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'    ]);        $response = curl_exec($ch);    if ($response === false) {        $error = "Failed to fetch activations page: " . curl_error($ch);        logMessage($error);        die($error);    }        $headerSize = curl_getinfo($ch, CURLINFO_HEADER_SIZE);    $headers = substr($response, 0, $headerSize);    $body = substr($response, $headerSize);    file_put_contents('activacion_view.html', $body);    file_put_contents('activacion_view_headers.txt', $headers);    logMessage("Fetched activations page, saved to activacion_view.html and activacion_view_headers.txt");        // Check for authentication errors    if (strpos($body, '<form') !== false && strpos($body, 'username') !== false) {        logMessage("Authentication failed: Redirected to login page when fetching activations");        die("Authentication failed: Redirected to login page when fetching activations. Check cookies in orbith_cookies.txt.");    }        if (preg_match('/Total: (\d+)/', $body, $matches)) {        $totalRecords = (int)$matches[1];        logMessage("Activations page fetched successfully, total records: $totalRecords");    } else {        logMessage("Could not parse total records in activations page");    }        // Scrape data    $records = [];    scrapeActivacionView($ch, $pdo, $records);    scrapeActivacionDetail($ch, $records);    scrapeEstadoRedView($ch, $records);    scrapeSignalData($ch, $pdo, $records);        // Save to database    saveToDatabase($pdo, $records);        logMessage("Scraping completed successfully, total records: " . count($records));    echo "Scraping completed successfully, total records: " . count($records) . "\n";        // Cleanup    curl_close($ch);    } catch (Exception $e) {    logMessage("Error: " . $e->getMessage());    echo "Error: " . $e->getMessage() . "\n";    if (isset($ch)) {        curl_close($ch);    }    exit(1);}?>